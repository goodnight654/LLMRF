# 基于元件灵敏度分析的 LLM 智能调参策略

## 3.x 灵敏度引导的射频滤波器智能优化

### 3.x.1 动机与问题设定

**优化困境分析。**  
在以大语言模型为核心的射频滤波器闭环设计系统中，当仿真结果未满足性能指标时，系统需要向 LLM 反馈"如何调整元件值"以引导下一轮迭代。现有基于启发式搜索的优化方法（遗传算法 GA、粒子群优化 PSO 等）将所有元件参数视为等权的设计自由度，在高维参数空间中进行盲目搜索，收敛速度慢且物理可解释性差。对于一个 $N$ 阶梯形滤波器，共有 $\lceil N/2 \rceil$ 个电感和 $\lfloor N/2 \rfloor$ 个电容，总参数维度为 $N$；当 $N = 9$ 时，$9$ 维参数空间中的盲目扰动极易引发振荡而非收敛。

**本文方案。**  
本文提出一种**基于元件灵敏度分析的 LLM 智能调参策略（Sensitivity-Guided LLM Tuning，SG-LLM）**，在每次闭环迭代前先对当前设计进行快速灵敏度计算，量化每个元件对关键性能指标的影响权重，再将结构化的灵敏度报告注入 LLM 上下文，引导模型**优先调整高灵敏度参数**，从而将无结构的参数搜索转化为物理知识驱动的定向优化。

---

### 3.x.2 梯形网络的解析灵敏度计算

**电路模型。**  
Chebyshev/Butterworth 低通滤波器均采用标准梯形（Ladder）拓扑：奇数位元件为串联电感，偶数位元件为并联电容，形成交替结构。设 $N$ 阶滤波器的归一化低通原型参数为 $\{g_k\}_{k=1}^{N}$，源阻为 $g_0 = 1$，负载为 $g_{N+1}$。将原型参数反归一化至实际设计值：

$$
L_k = \frac{g_{2k-1} \cdot R_0}{2\pi f_c}, \quad k = 1, 2, \ldots, \lceil N/2 \rceil
$$

$$
C_k = \frac{g_{2k}}{2\pi f_c \cdot R_0}, \quad k = 1, 2, \ldots, \lfloor N/2 \rfloor
$$

**ABCD 矩阵法。**  
本文采用 ABCD 矩阵（传输矩阵）法对梯形网络进行解析分析。对于归一化频率 $\omega_n$ 处的输入，令 $s = j\omega_n$，串联电感的传输矩阵和并联电容的传输矩阵分别为：

$$
\mathbf{M}_{\text{series}}^{(k)} = \begin{bmatrix} 1 & s \cdot g_k \\ 0 & 1 \end{bmatrix}, \quad
\mathbf{M}_{\text{shunt}}^{(k)} = \begin{bmatrix} 1 & 0 \\ s \cdot g_k & 1 \end{bmatrix}
$$

整个网络的级联传输矩阵为：

$$
\begin{bmatrix} A & B \\ C & D \end{bmatrix} = \prod_{k=1}^{N} \mathbf{M}^{(k)}
$$

由此得到归一化频率 $\omega_n$ 处的功率传输系数：

$$
|S_{21}(\omega_n)|^2 = \frac{4 R_L}{\left| A \cdot R_L + B + C \cdot R_L + D \right|^2}
$$

其中 $R_L = g_{N+1}$ 为归一化负载电阻。基于此，三项关键性能指标可由解析式给出：

- **阻带衰减**：$\mathcal{A}_s = -10\log_{10}|S_{21}(\omega_s)|^2$，其中 $\omega_s = f_s / f_c$
- **通带回波损耗**：$\mathcal{M}_{S_{11}} = 10\log_{10}(1 - \min_{\omega \in [0,1]}|S_{21}(\omega)|^2)$（取通带内最大反射）
- **通带纹波**：$\mathcal{R}_p = -10\log_{10}(\min_{\omega \in [0,1]}|S_{21}(\omega)|^2)$

相比调用 ADS 全电路仿真，ABCD 矩阵法的单次计算开销为 $\mathcal{O}(N)$，在闭环迭代中可实现毫秒级实时灵敏度更新。

---

### 3.x.3 归一化灵敏度定义与计算

**单元件灵敏度。**  
设性能指标集合为 $\mathcal{M} = \{\mathcal{A}_s, \mathcal{M}_{S_{11}}, \mathcal{R}_p\}$，第 $i$ 个元件的参数值为 $x_i$（$L_i$ 或 $C_i$）。对 $x_i$ 施加相对微扰 $\delta$（本文取 $\delta = 1\%$），定义第 $i$ 个元件对指标 $m$ 的**归一化灵敏度**为：

$$
S_{x_i}^{m} = \frac{\Delta m / m}{\Delta x_i / x_i} = \frac{m(x_i(1+\delta)) - m(x_i)}{m(x_i) \cdot \delta}
$$

该无量纲定义消除了不同量纲元件（nH 电感与 pF 电容）之间的不可比性，$|S_{x_i}^{m}| = 1$ 表示元件变化 $1\%$ 导致指标同比例变化 $1\%$。

**综合影响指数。**  
为对元件进行整体排序，本文定义第 $i$ 个元件的综合影响指数（Aggregate Impact Score，AIS）：

$$
\text{AIS}(x_i) = \sum_{m \in \mathcal{M}} \left| S_{x_i}^{m} \right|
$$

AIS 越大，说明该元件的微小改变对多项性能指标均有显著影响，是调参时应优先考虑的"关键元件"。

**优先级划分。**  
将所有 $N$ 个元件按 AIS 降序排列后，按三分位划分优先级：

$$
\text{Priority}(x_i) = \begin{cases}
\text{high}   & \text{rank}(x_i) \leq \lfloor N/3 \rfloor \\
\text{medium} & \lfloor N/3 \rfloor < \text{rank}(x_i) \leq \lfloor 2N/3 \rfloor \\
\text{low}    & \text{rank}(x_i) > \lfloor 2N/3 \rfloor
\end{cases}
$$

---

### 3.x.4 完整灵敏度分析算法

**算法 2**：SG-LLM 灵敏度分析

> **输入：** 滤波器设计规格 $(f_c, f_s, r, R_0, L_a, N, \text{type})$，微扰幅度 $\delta$  
> **输出：** 结构化灵敏度报告 $\mathcal{R}$
>
> 1. 调用滤波器综合算法，由规格计算低通原型参数 $\{g_k\}_{k=1}^{N}$ 及元件值 $\{L_i\}, \{C_i\}$
> 2. 利用 ABCD 矩阵法计算基线指标 $\mathbf{m}_0 = (\mathcal{A}_s^0, \mathcal{M}_{S_{11}}^0, \mathcal{R}_p^0)$
> 3. **For** $i = 1$ **to** $N$ **do**
>    - 令 $\tilde{g}_{k(i)} \leftarrow g_{k(i)} \cdot (1 + \delta)$，其余 $\tilde{g}_k = g_k$
>    - 计算扰动后指标 $\mathbf{m}_i$
>    - **For** each $m \in \mathcal{M}$ **do** 计算 $S_{x_i}^m \leftarrow (m_i - m_0^m) / (m_0^m \cdot \delta)$
>    - 计算 $\text{AIS}(x_i) \leftarrow \sum_m |S_{x_i}^m|$
> 4. 按 AIS 降序排列元件，分配优先级标签
> 5. 生成自然语言建议 $r_{\text{NL}}$，指明最高优先级元件及调整方向
> 6. 返回报告 $\mathcal{R} = \{\mathbf{m}_0, \{(x_i, \text{AIS}_i, \text{Priority}_i)\}, r_{\text{NL}}\}$

---

### 3.x.5 灵敏度信息的双重利用

**（一）闭环优化中的实时引导。**  
在 LLM 驱动的闭环调整迭代中，每轮仿真结束后若性能未达标，系统自动调用 `SensitivityAnalyzer.analyze_lpf()` 计算当前设计的灵敏度报告，并将其以结构化 JSON 格式注入 LLM 提示词：

```json
{
  "baseline_metrics": {"stopband_atten_dB": 38.2, "S11_max_dB": -12.4},
  "sensitivity_ranking": [
    {"element": "L2", "priority": "high",   "impact": 3.8821},
    {"element": "C1", "priority": "high",   "impact": 3.1047},
    {"element": "L1", "priority": "medium", "impact": 1.2334}
  ],
  "recommendation": "灵敏度最高的元件是 L2（电感, 值=8.34 nH），综合影响指数=3.88。建议优先调整该元件以加速收敛。"
}
```

LLM 接收此报告后，可将注意力集中在高优先级元件上，而非逐一分析所有元件，从而将单轮调参所需的推理步骤从 $\mathcal{O}(N)$ 降低为 $\mathcal{O}(k)$，其中 $k \ll N$ 为高优先级元件数量。

**（二）SFT 训练数据的知识注入。**  
为使模型在推理阶段内化灵敏度直觉（即无需显式计算即可判断哪些元件更关键），本文利用 `generate_sensitivity_dataset()` 批量生成灵敏度分析 SFT 样本。每条样本为三元组格式 `(system, user, assistant)`：

- `system`：射频专家角色设定
- `user`：包含完整设计规格的灵敏度分析请求
- `assistant`：包含基线指标、元件排序与自然语言建议的结构化输出

共生成 $200$ 条覆盖多阶数（$N=3\!\sim\!9$）、多中心频率（$400\,\text{MHz}\!\sim\!2\,\text{GHz}$）、多拓扑类型（Chebyshev/Butterworth）的灵敏度 SFT 样本，并使用 `generate_sensitivity_sft_sample()` 接口将其整合进统一训练集。通过在 SFT 阶段学习大量灵敏度分析实例，模型逐步建立起"元件位置—拓扑贡献—性能主导性"的隐式映射，形成可迁移的**射频设计直觉（RF Design Intuition）**。

---

### 3.x.6 与已有方法的比较

传统灵敏度分析方法（如有限差分法、伴随方法）主要服务于数值优化器，用于计算梯度方向；本文的 SG-LLM 策略在以下三个维度上具有显著差异：

| 维度 | 传统方法 | 本文 SG-LLM |
|---|---|---|
| **目标角色** | 为数值优化器提供梯度 | 为 LLM 提供物理直觉上下文 |
| **输出形式** | 数值梯度向量 $\nabla_\mathbf{x} \mathcal{L}$ | 结构化优先级报告 + 自然语言建议 |
| **计算方式** | 通常依赖全电路仿真（如 ADS S 参数扫描） | ABCD 矩阵解析法，$\mathcal{O}(N)$，毫秒级 |
| **知识迁移** | 逐实例计算，不可复用 | 通过 SFT 注入，模型内化为隐式知识 |
| **可解释性** | 数值结果难以直接解读 | 优先级标签 + 中文自然语言建议 |

此外，本文的灵敏度计算在**归一化原型域**（normalized prototype domain）进行，规避了实际频率和阻抗值带来的数值量纲差异，使电感（nH 级）与电容（pF 级）的灵敏度可以直接比较，这是在物理参数域进行有限差分所无法实现的优势。
