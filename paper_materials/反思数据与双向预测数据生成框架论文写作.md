# 面向射频设计直觉的多任务 SFT 数据构建框架

## 3.x 反思推理数据与双向预测数据的自动化生成

### 3.x.1 问题背景与动机

**LLM 射频设计能力的两大核心缺口。**  
现有大语言模型在零样本射频设计任务中存在两类系统性缺陷：其一，**缺乏自我纠错能力**——当仿真结果不达标时，模型无法识别根因并给出针对性修正，往往陷入无效的随机扰动循环；其二，**缺乏双向映射直觉**——标准 SFT 仅训练"规格→参数"的单向映射，模型无法建立"给定元件值，直觉估计其性能"的逆向工程能力，而这恰是人类资深射频工程师的核心认知优势。

**本文方案概述。**  
为填补上述缺口，本文设计了一套**多任务 SFT 数据自动化构建框架**，包含两个相互正交的数据生成流水线：①**偏差注入-反思修正数据生成**（Perturbation-Induced Reflection，PIR），通过程序化地向设计规格注入可控偏差并触发规则引擎生成专家级修正推理链，使模型习得闭环调参的元认知能力；②**双向预测数据生成**（Bidirectional Performance Prediction，BPP），通过正向性能预测与设计比较两类任务，促使模型在参数空间与性能空间之间建立稠密的双向表示。下文分别详述。

---

### 3.x.2 偏差注入-反思修正数据生成（PIR）

#### 3.x.2.1 总体设计

PIR 流水线的核心目标是自动化地生成大量**"不达标→分析→修正"**三段式多轮对话样本，覆盖低通（LPF）、高通（HPF）、带通（BPF）三类滤波器拓扑。完整流程如图所示，分为六个阶段：

$$
\text{理想规格} \xrightarrow{\text{偏差注入}} \text{劣化规格} \xrightarrow{\text{公式仿真}} \text{仿真指标} \xrightarrow{\text{评估引擎}} \text{问题诊断}
\xrightarrow{\text{反思引擎}} \text{修正规格} \xrightarrow{\text{验证}} \text{SFT样本}
$$

#### 3.x.2.2 偏差注入策略

设理想设计规格为 $\mathcal{S}^* = (f_c, f_s, r, R_0, L_a, N, T)$，其中 $f_c$ 为截止频率，$f_s$ 为阻带频率，$r$ 为通带纹波，$R_0$ 为端口阻抗，$L_a$ 为目标阻带衰减，$N$ 为滤波器阶数，$T \in \{\text{Chebyshev}, \text{Butterworth}\}$ 为类型。本文设计四种偏差注入策略 $\mathcal{P} = \{p_1, p_2, p_3, p_4\}$，在理想规格 $\mathcal{S}^*$ 上施加受控扰动得到劣化规格 $\tilde{\mathcal{S}}$：

| 策略 $p_k$ | 操作 | 预期失效模式 |
|---|---|---|
| $p_1$：阶数严重偏低 | $\tilde{N} \leftarrow N - \Delta N,\; \Delta N \in \{2,3\}$ | 阻带衰减严重不足，$\mathcal{A}_s \ll L_a$ |
| $p_2$：截止频率漂移 | $\tilde{f}_c \leftarrow f_c \cdot (1 \pm \alpha),\; \alpha \in [0.1, 0.3]$ | 通带/阻带边界错位 |
| $p_3$：纹波过大 | $\tilde{r} \leftarrow r \cdot \beta,\; \beta \in [2, 5]$ | S11 匹配劣化，通带平坦度超标 |
| $p_4$：阶数轻微偏低 | $\tilde{N} \leftarrow N - 1$ | 差一步达标，考验模型的精细判断 |

策略 $p_4$ 的设计尤为重要：当 $\Delta N = 1$ 时，仿真结果处于恰好未达标的边界区域，这要求模型能够进行精细的定量分析（"差 $3.2\,\text{dB}$，需要增加1阶"），而非粗糙的定性判断，从而强化模型对设计裕度的量化直觉。

#### 3.x.2.3 评估引擎

对劣化规格 $\tilde{\mathcal{S}}$ 经公式仿真得到指标集 $\mathcal{M} = (\mathcal{A}_s, \mathcal{R}_p, M_{S_{11}})$ 后，评估引擎依据以下判定条件生成问题列表 $\mathcal{I}$：

$$
\mathcal{I} = 
\underbrace{\left\{ \text{"阻带衰减不足"} \;\middle|\; \mathcal{A}_s < L_a \right\}}_{\text{主要失效}} \cup
\underbrace{\left\{ \text{"通带纹波过大"} \;\middle|\; \mathcal{R}_p > 1.5 \cdot r \right\}}_{\text{通带失效}} \cup
\underbrace{\left\{ \text{"S11过高"} \;\middle|\; M_{S_{11}} > -10\,\text{dB} \right\}}_{\text{匹配失效}}
$$

每条问题描述均携带量化信息（如"阻带衰减不足：实际 $38.2\,\text{dB}$ < 目标 $45\,\text{dB}$，差距 $6.8\,\text{dB}$"），确保后续反思文本具备可被模型学习的数值推理结构。

#### 3.x.2.4 规则反思引擎

规则反思引擎（Rule-based Reflection Engine，RRE）基于问题列表 $\mathcal{I}$ 生成**专家级推理链**和**修正规格** $\hat{\mathcal{S}}$，其核心为阶数增量决策函数：

$$
\Delta N = \begin{cases}
3 & \text{if } \Delta L_a > 15\,\text{dB} \\
2 & \text{if } 8\,\text{dB} < \Delta L_a \leq 15\,\text{dB} \\
1 & \text{if } \Delta L_a \leq 8\,\text{dB}
\end{cases}
, \quad \Delta L_a = L_a - \mathcal{A}_s
$$

该函数基于 Chebyshev 滤波器的阶数-衰减单调关系（每增加1阶约提升 $6 \sim 20\,\text{dB}$ 衰减，具体取决于 $f_s/f_c$ 的比值）推导而来。对于纹波超标问题，引擎输出纹波系数折减决策 $\hat{r} \leftarrow 0.6 \cdot \tilde{r}$，并附有阻抗匹配改善的物理解释。

生成的反思文本结构固定为三段：**问题陈述**（量化差距）→ **物理机理分析**（引用滤波器理论）→ **修正方案**（具体参数变更），例如：

> 上一轮仿真发现以下问题：  
> - 阻带衰减不足：实际 38.2 dB < 目标 45 dB，差距 6.8 dB  
>
> 分析：阻带衰减差距为 6.8 dB。根据切比雪夫理论，每增加1阶大约增加 6~20 dB 衰减。因此将阶数从 5 增加到 6。  
>
> 调整方案：order: 5 → 6。

修正规格 $\hat{\mathcal{S}}$ 随后经过**二次公式仿真验证**，确保修正后性能确实改善（$\hat{\mathcal{A}}_s > \mathcal{A}_s$），不满足验证条件的样本被过滤丢弃，保证了数据集的物理一致性。

#### 3.x.2.5 样本类型与数据分布

PIR 流水线同时生成两类互补样本：

- **反思修正样本**（Reflection Correction，RC）：三轮对话，`(system, user[问题规格+不达标指标], assistant[推理链+修正JSON])`，共约 $N_{\text{RC}}$ 条
- **评估判断样本**（Pass/Fail Evaluation，PFE）：单轮判断，训练模型的"达标识别"能力，共约 $N_{\text{PFE}}$ 条

设定 $N_{\text{LPF}} = 500$，$N_{\text{HPF}} = 150$，$N_{\text{BPF}} = 150$，按 $9 : 0.5 : 0.5$ 的比例切分训练/验证/测试集。数据集刻意保持三类拓扑的非均衡分布（LPF 占主体），以反映实际工程中各类滤波器的使用频率分布，同时引入课程学习排序（详见 3.x 节）进行训练前重排序。

---

### 3.x.3 双向预测数据生成（BPP）

#### 3.x.3.1 双向学习的认知动机

标准 SFT 训练范式建立的是**单向条件映射** $P(\text{参数} \mid \text{规格})$。然而，人类射频工程师在长期实践中会发展出双向认知能力：不仅能从规格推算参数，更能从元件值直觉判断其性能，进而在两组设计方案间快速做出工程权衡。本文通过 BPP 数据将这一双向能力显式引入训练目标：

$$
\underbrace{P(\text{规格} \mid \text{参数})}_{\text{正向预测任务}} + \underbrace{P(\text{优劣判断} \mid \text{参数}_A, \text{参数}_B)}_{\text{设计比较任务}}
$$

#### 3.x.3.2 正向性能预测任务

正向预测任务要求模型在给定 $N$ 阶 Chebyshev 滤波器的完整元件清单（$\{L_i\}_{i=1}^{\lceil N/2 \rceil}$，单位 nH；$\{C_i\}_{i=1}^{\lfloor N/2 \rfloor}$，单位 pF）及端口参数后，输出结构化性能指标 JSON。

性能指标的真值标签由切比雪夫理论公式精确计算：

**阻带衰减：**
$$
\mathcal{A}_s = 10\log_{10}\!\left[1 + \varepsilon^2 \cosh^2\!\left(N \cdot \text{arccosh}\frac{\omega_s}{\omega_c}\right)\right], \quad \varepsilon^2 = 10^{r/10} - 1
$$

**通带回波损耗：**
$$
M_{S_{11}} = 10\log_{10}\!\left(1 - 10^{-r/10}\right)
$$

**群延时近似：**
$$
\tau_g \approx \frac{N}{2\pi f_c} \; [\text{s}]
$$

为增强模型的语言泛化能力，用户消息以三种语言风格随机生成（中文、英文、中英混合），概率各 $1/3$，使模型同时具备中文和英文射频术语的理解能力。

#### 3.x.3.3 设计比较与工程权衡任务

比较任务提供两个在相同规格下设计的滤波器方案 $\mathcal{D}_A$（较低阶）与 $\mathcal{D}_B$（较高阶），要求模型依据工程最优原则给出判断。判断逻辑遵循以下优先序：

$$
\text{Winner} = \begin{cases}
B & \mathcal{D}_B \text{ 达标} \wedge \mathcal{D}_A \text{ 不达标} \\
A & \mathcal{D}_A \text{ 达标} \wedge \mathcal{D}_B \text{ 不达标} \\
A & \mathcal{D}_A \text{ 达标} \wedge \mathcal{D}_B \text{ 达标} \quad [\text{奥卡姆原则：最简达标方案}] \\
B & \mathcal{D}_A \text{ 不达标} \wedge \mathcal{D}_B \text{ 不达标} \quad [\text{性能更优者}]
\end{cases}
$$

当两者均达标时选择低阶方案 $\mathcal{D}_A$，体现工程实践中的**奥卡姆剃刀原则**：在满足指标约束的前提下，元件数更少的方案具有更低的成本、更小的群延时和更高的可制造性。通过大量此类比较样本训练，模型将内化"够用即好"的工程权衡直觉，避免过度设计倾向。

#### 3.x.3.4 数据规模与构成

BPP 数据集设定：
- **正向预测样本**：$N_{\text{predict}} = 300$ 条，覆盖阶数 $N \in [3,9]$、中心频率 $[400\,\text{MHz}, 2.5\,\text{GHz}]$、双滤波器类型
- **比较分析样本**：$N_{\text{compare}} = 100$ 条，每对方案阶数差 $\Delta N \in [1,3]$

两类样本混合打乱后写入 `reverse_prediction_train.jsonl`，与 PIR 数据集、灵敏度数据集共同通过课程学习框架排序合并为最终训练集。

---

### 3.x.4 数据集整体统计与质量保证

**整体规模。** 三个数据流水线（PIR、BPP、灵敏度分析）的输出经合并后，总 SFT 训练样本量为：

$$
N_{\text{total}} = N_{\text{RC}} + N_{\text{PFE}} + N_{\text{predict}} + N_{\text{compare}} + N_{\text{sensitivity}}
$$

**质量保证机制。** 本框架内置三层质量过滤：（i）**物理一致性验证**：反思修正样本要求修正后指标严格优于修正前，不满足则丢弃；（ii）**参数域合法性检查**：拒绝生成奈奎斯特不合规的频率配置（如 $f_s < f_c$ 的低通场景）；（iii）**异常捕获机制**：设计器调用失败（如阶数参数越界）的样本自动跳过并记录，确保训练集中无格式异常样本。

**与已有数据构建策略的对比。**  

| 维度 | 传统人工标注 SFT | Self-Instruct / 蒸馏 | 本文 PIR + BPP |
|---|---|---|---|
| **数据来源** | 人类专家撰写 | GPT-4 生成 | 物理仿真公式 + 规则引擎 |
| **物理可信度** | 高（但规模有限） | 低（可能含幻觉） | 高（解析公式严格保证） |
| **覆盖维度** | 单向设计 | 单向设计为主 | 正向设计 + 反思纠错 + 双向预测 + 设计比较 |
| **可扩展性** | 差（专家时间受限） | 中（依赖闭源API） | 极强（程序化生成，无上限） |
| **知识类型** | 显式知识 | 程序性知识（部分） | 程序性知识 + 元认知能力 + 工程直觉 |

本文框架通过**程序化物理仿真替代人工标注或模型蒸馏**，在保证数据物理正确性的前提下实现了训练数据的大规模自动化生成，这是领域专用 LLM 微调数据构建的一个通用范式贡献，可推广至其他 EDA 场景（天线设计、放大器偏置优化等）。
